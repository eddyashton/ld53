pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
function v2(_x, _y)
 return {x=_x, y=_y}
end

function v2_add(_v1,_v2)
 return v2(_v1.x+_v2.x, _v1.y+_v2.y)
end

function _update()
 local tr = trucks[1]
 if (btnp(⬆️)) tr.dir = up
 if (btnp(➡️)) tr.dir = right
 if (btnp(⬇️)) tr.dir = down
 if (btnp(⬅️)) tr.dir = left
 if (btnp(❎)) tr.full = not tr.full
 if (btnp(🅾️)) tr.blue = not tr.blue
 
 if (btnp(⬆️) or btnp(➡️) or btnp(⬇️) or btnp(⬅️)) then
  tr.pos = v2_add(tr.pos, tr.dir)
 end
 
 if t() >= update_at then
  for tr in all(trucks) do
	  tr.pos = v2_add(tr.pos, tr.dir)
	  -- loop off screen edges
	  if (tr.dir == right and tr.pos.x > 128) tr.pos.x = -4
	  if (tr.dir == left and tr.pos.x < -1) tr.pos.x = 131
	  if (tr.dir == down and tr.pos.y > 131) tr.pos.y = 0
	  if (tr.dir == up and tr.pos.y < 0) tr.pos.y = 131
	  update_at = t() + 0.1
  end
 end
end

function _init()
 
 up = v2(0, -1)
 right = v2(1, 0)
 down = v2(0, 1)
 left = v2(-1, 0)
 
 function mk_truck(b,p,d,f)
  return {
   blue = b,
   pos = p,
   dir = d,
   full = f or false
  }
 end

 trucks = {
  mk_truck(false, v2(110,110), right),
   
  mk_truck(false, v2(80,48), right),
  mk_truck(true, v2(80,56), right),
  mk_truck(false, v2(80,64), right, true),
  mk_truck(true, v2(80,72), right, true),
  
  mk_truck(false, v2(72,72), down),
  mk_truck(true, v2(64,72), down),
  mk_truck(false, v2(56,72), down, true),
  mk_truck(true, v2(48,72), down, true),
  
  mk_truck(false, v2(48,64), left),
  mk_truck(true, v2(48,56), left),
  mk_truck(false, v2(48,48), left, true),
  mk_truck(true, v2(48,40), left, true),
  
  mk_truck(false, v2(56,40), up),
  mk_truck(true, v2(64,40), up),
  mk_truck(false, v2(72,40), up, true),
  mk_truck(true, v2(80,40), up, true),
 }
 update_at = t() + 0.5
end

function sspr_args(pos,dir)
 local x,sx
 -- common to all or most sprites
 local y,sy,xoff = 8,5,-1
 if dir == left or dir == right then
  x = 0
  sx = 6
  if dir == right then xoff = -1
  else xoff = -4 end
 elseif dir == up then
  x = 7
  sx = 3
 elseif dir == down then
  x = 11
  sx = 3
 else
  assert(false, "unexpected dir:"..dir)
 end

 return {
  x,y,
  sx,sy,
  pos.x+xoff,pos.y-(sy-1),
  sx,sy,
  dir==left, --flip_x
 }
end

function draw_truck(truck)
 pal()
 palt(0, false)
 local pos = truck.pos
 local dir = truck.dir
 local truck_colour = 8
 if truck.blue then
  -- swap red to blue
  pal(8, 12)
  truck_colour = 12
 end
 if truck.full then
  pal(7, truck_colour)
 end
 sspr(
  unpack(
   sspr_args(truck.pos, truck.dir)
  )
 )
end

function _draw()
 cls(6)
 
 for truck in all(trucks) do
  draw_truck(truck)
 end
 
 color(0)
 local tr = trucks[1]
 print(tr.dir.x..","..tr.dir.y)
 print(tr.full and "full" or "empty")
 print(tr.blue and "blue" or "red")
end
__gfx__
00000000000000006688866666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000006887886666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000008877788666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000008787878666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000008887888666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000006887886666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000006688866666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000006666666666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88886668886878666666666666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
87785868786555666666666666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
87785568786888666666666666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88885568886555666666666666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06606660606060666666666666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666666666666666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccc6666666666666666666666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccc5c66666666666666666666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccc5566666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccc5566666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06606666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
