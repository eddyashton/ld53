pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
function v2(_x, _y)
 return {x=_x, y=_y}
end

function v2_add(_v1,_v2)
 return v2(_v1.x+_v2.x, _v1.y+_v2.y)
end

function _update()
 -- manual control of first truck
 local tr = trucks[1]
 if (btnp(⬆️)) tr.dir = up
 if (btnp(➡️)) tr.dir = right
 if (btnp(⬇️)) tr.dir = down
 if (btnp(⬅️)) tr.dir = left
 if (btnp(❎)) tr.full = not tr.full
 if (btnp(🅾️)) tr.blue = not tr.blue
 
 if (btnp(⬆️) or btnp(➡️) or btnp(⬇️) or btnp(⬅️)) then
  tr.pos = v2_add(tr.pos, tr.dir)
 end
 
 if t() >= update_at then
  for tr in all(trucks) do
	  --tr.pos = v2_add(tr.pos, tr.dir)
	  -- loop off screen edges
	  if (tr.dir == right and tr.pos.x > 128) tr.pos.x = -4
	  if (tr.dir == left and tr.pos.x < -1) tr.pos.x = 131
	  if (tr.dir == down and tr.pos.y > 131) tr.pos.y = 0
	  if (tr.dir == up and tr.pos.y < 0) tr.pos.y = 131
	  update_at = t() + move_delay
  end
 end
end

function _init()
 move_delay = 0.1
 update_at = t() + move_delay
 
 up = v2(0, -1)
 right = v2(1, 0)
 down = v2(0, 1)
 left = v2(-1, 0)
 
 function mk_truck(b,p,d,f)
  return {
   blue = b,
   pos = p,
   dir = d,
   full = f or false
  }
 end

 trucks = {
  mk_truck(false, v2(66,75), right),
 }
 
 roads = {}
 for y=0,16 do
  local row = {}
  for x=0,16 do
   if sget(x+112, y+48) == 6 then
    row[x] = true
   end
  end
  roads[y] = row
 end
end

function sspr_args(pos,dir)
 local x,sx
 -- common to all or most sprites
 local y,sy,xoff = 8,5,-1
 if dir == left or dir == right then
  x = 0
  sx = 6
  if dir == right then xoff = -1
  else xoff = -4 end
 elseif dir == up then
  x = 7
  sx = 3
 elseif dir == down then
  x = 11
  sx = 3
 else
  assert(false, "unexpected dir:"..dir)
 end

 return {
  x,y,
  sx,sy,
  pos.x+xoff,pos.y-(sy-1),
  sx,sy,
  dir==left, --flip_x
 }
end

function draw_truck(truck)
 pal()
 palt(0, false)
 palt(6, true)
 local pos = truck.pos
 local dir = truck.dir
 local truck_colour = 8
 if truck.blue then
  -- swap red to blue
  pal(8, 12)
  truck_colour = 12
 end
 if truck.full then
  pal(7, truck_colour)
 end
 sspr(
  unpack(
   sspr_args(truck.pos, truck.dir)
  )
 )
end

function draw_roads()
 --[[
 -- border hedges
 for road in all(roads) do
  local x,y = 8*road.x, 8*road.y
  rect(
   x-1,y-1,
   x+7,y+7,
   3
  )
 end
 ]]--

 for cy,row in pairs(roads) do
  for cx, _ in pairs(row) do
	  -- tarmac
 	 local x,y = 8*cx, 8*cy
	  rectfill(
	  	x,y,
	  	x+6,y+6,
	  	6
 	 )
  
  	-- white lines
   --- left
   local cl,cr = (cx-1)%16,(cx+1)%16
   local cu,cd = (cy-1)%16,(cy+1)%16
   if row[cl] then
    line(x,y+3,x+2,y+3,7)
   end
   --- up
   if roads[cu] and roads[cu][cx] then
    line(x+3,y,x+3,y+2,7)
   end
   --- right
   if row[cr] then
    line(x+4,y+3,x+6,y+3,7)
    --- patch tarmac
    line(x+7,y,x+7,y+6,6)
   end
   -- down
   if roads[cd] and roads[cd][cx] then
    line(x+3,y+4,x+3,y+6,7)
    --- patch tarmac
    line(x,y+7,x+6,y+7,6)
   end
	  
	 end
 end

end

function _draw()
 cls(11)
 pal()
 
 draw_roads()

--[[ 
 -- draw map
 map(0, 0, 64, 64, 4, 5)
]]--
 
 -- draw all trucks
 for truck in all(trucks) do
  draw_truck(truck)
 end
 
 color(0)
 local tr = trucks[1]
 print(tr.dir.x..","..tr.dir.y)
 print(tr.full and "full" or "empty")
 print(tr.blue and "blue" or "red")
end
__gfx__
00000000000000006688866633333333666677776666777733333333000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000006887886666666666666666666666666766666666000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000008877788666666666666666666666666766666666000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000008787878666666666666666666666666766666666000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000008887888677776777677767776777677777776777000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000006887886666666666666666666666666676666666000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000006688866666666666666666666666666676666666000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000006666666666666666666666666666666676666666000000000000000000000000000000000000000000000000000000000000000000000000
88886668886878663666766633333333333333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
87785868786555663666766636666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
87785568786888663666766636666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88885568886555663666666636666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06606660606060663666766636666777677766660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666663666766636667666666676660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccc6666666666663666766636667666666676660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccc5c66666666663666666636667666666676660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccc5566666666667666766636666666366666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccc5566666666667666766636667666666676660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06606666666666667666766636667666666676660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666667666666636667666666676660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666666666766636666777677766660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666666666766636666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666666666766636666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666666666666636666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000007777766600000000000000007666777700000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000007666766600000000000000007666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000007666766600000000000000007666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000007666666600000000000000007666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000006666766600000000000000006666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000006666766600000000000000006666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000006666766600000000000000006666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000006666666600000000000000006666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bbb6bbbbbb6bbbbb
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b666bb666b66666b
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b6b6666b666b6b6b
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b6bbbbbb6b6b6b6b
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b6bbbbbb6b6b666b
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006666666666666b66
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b6b6bb6bb6bb6b6b
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b666666666bb6b6b
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bb6bb6bbb6bb666b
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bb6bb6bbb6bb6b6b
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006666666666666666
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b6bb6b6bb6b6bb6b
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b6bb6b6bb6b6666b
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b66b6b6bb6bbb6bb
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bb666b66666666bb
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bbb6bbbbbb6bbbbb
__map__
1303031400000000000003030314000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1200001200000000000013141324000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1200001200000000000012121213000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2303032400000000000023350412000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000003320603000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
